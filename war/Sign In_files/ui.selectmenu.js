define(["jquery","jqueryui"],function(a,b){a.widget("ui.selectmenu",{getter:"value",version:"1.8",eventPrefix:"selectmenu",options:{transferClasses:!0,style:"popup",width:null,menuWidth:null,handleWidth:26,maxHeight:300,icons:null,format:null},_create:function(){var b=this,c=this.options,d=this.element.attr("id")||"ui-selectmenu-"+Math.random().toString(16).slice(2,10);this.ids=[d+"-"+"button",d+"-"+"menu"],this._safemouseup=!0,this.newelement=a('<a class="'+this.widgetBaseClass+' ui-widget ui-state-default ui-corner-all" id="'+this.ids[0]+'" role="button" href="#" aria-haspopup="true" aria-owns="'+this.ids[1]+'"></a>').insertAfter(this.element);var e=this.element.attr("tabindex");e&&this.newelement.attr("tabindex",e),this.newelement.data("selectelement",this.element),this.selectmenuIcon=a('<span class="'+this.widgetBaseClass+'-icon ui-icon"></span>').prependTo(this.newelement).addClass(c.style=="popup"?"ui-icon-triangle-2-n-s":"ui-icon-triangle-1-s"),a("label[for="+this.element.attr("id")+"]").attr("for",this.ids[0]).bind("click",function(){return b.newelement[0].focus(),!1}),this.newelement.bind("mousedown",function(a){return b._toggle(a),c.style=="popup"&&(b._safemouseup=!1,setTimeout(function(){b._safemouseup=!0},300)),!1}).bind("click",function(){return!1}).keydown(function(c){var d=!0;switch(c.keyCode){case a.ui.keyCode.ENTER:d=!0;break;case a.ui.keyCode.SPACE:d=!1,b._toggle(c);break;case a.ui.keyCode.UP:case a.ui.keyCode.LEFT:d=!1,b._moveSelection(-1);break;case a.ui.keyCode.DOWN:case a.ui.keyCode.RIGHT:d=!1,b._moveSelection(1);break;case a.ui.keyCode.TAB:d=!0;break;default:d=!1,b._typeAhead(c.keyCode,"mouseup")}return d}).bind("mouseover focus",function(){c.disabled||a(this).addClass(b.widgetBaseClass+"-focus ui-state-hover")}).bind("mouseout blur",function(){c.disabled||a(this).removeClass(b.widgetBaseClass+"-focus ui-state-hover")}),a(document).mousedown(function(a){b.close(a)}),this.element.click(function(){this._refreshValue()}).focus(function(){this.newelement&&this.newelement[0].focus()});var f=c.style=="dropdown"?" ui-corner-bottom":" ui-corner-all";this.list=a('<ul class="'+b.widgetBaseClass+"-menu ui-widget ui-widget-content"+f+'" aria-hidden="true" role="listbox" aria-labelledby="'+this.ids[0]+'" id="'+this.ids[1]+'"></ul>').appendTo("body");var g=[];this.element.find("option").each(function(){g.push({value:a(this).attr("value"),text:b._formatText(jQuery(this).text()),selected:a(this).attr("selected"),classes:a(this).attr("class"),parentOptGroup:a(this).parent("optgroup").attr("label")})});var h=b.options.style=="popup"?" ui-state-active":"";for(var i=0;i<g.length;i++){var j=a('<li role="presentation"><a href="#" tabindex="-1" role="option" aria-selected="false">'+g[i].text+"</a></li>").data("index",i).addClass(g[i].classes).data("optionClasses",g[i].classes||"").mouseup(function(c){if(b._safemouseup){var d=a(this).data("index")!=b._selectedIndex();b.value(a(this).data("index")),b.select(c),d&&b.change(c),b.close(c,!0)}return!1}).click(function(){return!1}).bind("mouseover focus",function(){b._selectedOptionLi().addClass(h),b._focusedOptionLi().removeClass(b.widgetBaseClass+"-item-focus ui-state-hover"),a(this).removeClass("ui-state-active").addClass(b.widgetBaseClass+"-item-focus ui-state-hover")}).bind("mouseout blur",function(){a(this).is(b._selectedOptionLi())&&a(this).addClass(h),a(this).removeClass(b.widgetBaseClass+"-item-focus ui-state-hover")});if(g[i].parentOptGroup){var k=b.widgetBaseClass+"-group-"+g[i].parentOptGroup.replace(/[^a-zA-Z0-9]/g,"");this.list.find("li."+k).size()?this.list.find("li."+k+":last ul").append(j):a('<li role="presentation" class="'+b.widgetBaseClass+"-group "+k+'"><span class="'+b.widgetBaseClass+'-group-label">'+g[i].parentOptGroup+"</span><ul></ul></li>").appendTo(this.list).find("ul").append(j)}else j.appendTo(this.list);this.list.bind("mousedown mouseup",function(){return!1});if(c.icons)for(var l in c.icons)if(j.is(c.icons[l].find)){j.data("optionClasses",g[i].classes+" "+b.widgetBaseClass+"-hasIcon").addClass(b.widgetBaseClass+"-hasIcon");var m=c.icons[l].icon||"";j.find("a:eq(0)").prepend('<span class="'+b.widgetBaseClass+"-item-icon ui-icon "+m+'"></span>')}}this.list.find("li:last").addClass("ui-corner-bottom"),c.style=="popup"&&this.list.find("li:first").addClass("ui-corner-top");if(c.transferClasses){var n=this.element.attr("class")||"";this.newelement.add(this.list).addClass(n)}var o=this.element.width();this.newelement.width(c.width?c.width:o),c.style=="dropdown"?this.list.width(c.menuWidth?c.menuWidth:c.width?c.width:o):this.list.width(c.menuWidth?c.menuWidth:c.width?c.width-c.handleWidth:o-c.handleWidth),c.maxHeight&&c.maxHeight<this.list.height()&&this.list.height(c.maxHeight),this._optionLis=this.list.find("li:not(."+b.widgetBaseClass+"-group)"),this.list.keydown(function(c){var d=!0;switch(c.keyCode){case a.ui.keyCode.HOME:d=!1,b._moveFocus(":first");break;case a.ui.keyCode.PAGE_UP:d=!1,b._scrollPage("up");break;case a.ui.keyCode.PAGE_DOWN:d=!1,b._scrollPage("down");break;case a.ui.keyCode.END:d=!1,b._moveFocus(":last");break;case a.ui.keyCode.ENTER:case a.ui.keyCode.SPACE:d=!1,b.close(c,!0),a(c.target).parents("li:eq(0)").trigger("mouseup");break;case a.ui.keyCode.TAB:d=!0,b.close(c,!0);break;case a.ui.keyCode.ESCAPE:d=!1,b.close(c,!0);break;default:d=!1,b._typeAhead(c.keyCode,"focus")}return d}),c.style=="dropdown"?(this.newelement.addClass(b.widgetBaseClass+"-dropdown"),this.list.addClass(b.widgetBaseClass+"-menu-dropdown")):(this.newelement.addClass(b.widgetBaseClass+"-popup"),this.list.addClass(b.widgetBaseClass+"-menu-popup")),this.newelement.prepend('<span class="'+b.widgetBaseClass+'-status">'+g[this._selectedIndex()].text+"</span>"),this.element.hide(),this.element.attr("disabled")==1&&this.disable(),this.value(this._selectedIndex()),a(window).resize(function(){b._refreshPosition()})},destroy:function(){this.element.removeData(this.widgetName).removeClass(this.widgetBaseClass+"-disabled"+" "+this.namespace+"-state-disabled").removeAttr("aria-disabled").unbind("click"),a("label[for="+this.newelement.attr("id")+"]").attr("for",this.element.attr("id")).unbind("click"),this.newelement.remove(),this.list.remove(),this.element.show(),a.Widget.prototype.destroy.apply(this,arguments)},_typeAhead:function(b,d){function h(b,c){g=!0,a(b).trigger(d),e._prevChar[1]=c}var e=this;e._prevChar||(e._prevChar=["",0]);var f=String.fromCharCode(b);c=f.toLowerCase();var g=!1;this.list.find("li a").each(function(b){if(!g){var d=a(this).text();if(d.indexOf(f)==0||d.indexOf(c)==0)e._prevChar[0]==f?e._prevChar[1]<b&&h(this,b):h(this,b)}}),this._prevChar[0]=f},_uiHash:function(){var b=this.value();return{index:b,option:a("option",this.element).get(b),value:this.element[0].value}},open:function(a){var b=this,c=this.newelement.attr("aria-disabled");c!="true"&&(this._refreshPosition(),this._closeOthers(a),this.newelement.addClass("ui-state-active"),this.list.appendTo("body").addClass(b.widgetBaseClass+"-open").attr("aria-hidden",!1).find("li:not(."+b.widgetBaseClass+"-group):eq("+this._selectedIndex()+") a")[0].focus(),this.options.style=="dropdown"&&this.newelement.removeClass("ui-corner-all").addClass("ui-corner-top"),this._refreshPosition(),this._trigger("open",a,this._uiHash()))},close:function(a,b){this.newelement.is(".ui-state-active")&&(this.newelement.removeClass("ui-state-active"),this.list.attr("aria-hidden",!0).removeClass(this.widgetBaseClass+"-open"),this.options.style=="dropdown"&&this.newelement.removeClass("ui-corner-top").addClass("ui-corner-all"),b&&this.newelement[0].focus(),this._trigger("close",a,this._uiHash()))},change:function(a){this.element.trigger("change"),this._trigger("change",a,this._uiHash())},select:function(a){this._trigger("select",a,this._uiHash())},_closeOthers:function(b){a("."+this.widgetBaseClass+".ui-state-active").not(this.newelement).each(function(){a(this).data("selectelement").selectmenu("close",b)}),a("."+this.widgetBaseClass+".ui-state-hover").trigger("mouseout")},_toggle:function(a,b){this.list.is("."+this.widgetBaseClass+"-open")?this.close(a,b):this.open(a)},_formatText:function(a){return this.options.format?this.options.format(a):a},_selectedIndex:function(){return this.element[0].selectedIndex},_selectedOptionLi:function(){return this._optionLis.eq(this._selectedIndex())},_focusedOptionLi:function(){return this.list.find("."+this.widgetBaseClass+"-item-focus")},_moveSelection:function(a){var b=parseInt(this._selectedOptionLi().data("index"),10),c=b+a;return this._optionLis.eq(c).trigger("mouseup")},_moveFocus:function(a){if(!isNaN(a))var b=parseInt(this._focusedOptionLi().data("index"),10),c=b+a;else var c=parseInt(this._optionLis.filter(a).data("index"),10);c<0&&(c=0),c>this._optionLis.size()-1&&(c=this._optionLis.size()-1);var d=this.widgetBaseClass+"-item-"+Math.round(Math.random()*1e3);this._focusedOptionLi().find("a:eq(0)").attr("id",""),this._optionLis.eq(c).find("a:eq(0)").attr("id",d)[0].focus(),this.list.attr("aria-activedescendant",d)},_scrollPage:function(a){var b=Math.floor(this.list.outerHeight()/this.list.find("li:first").outerHeight());b=a=="up"?-b:b,this._moveFocus(b)},_setOption:function(a,b){this.options[a]=b,a=="disabled"&&(this.close(),this.element.add(this.newelement).add(this.list)[b?"addClass":"removeClass"](this.widgetBaseClass+"-disabled"+" "+this.namespace+"-state-disabled").attr("aria-disabled",b))},value:function(a){return arguments.length&&(this.element[0].selectedIndex=a,this._refreshValue(),this._refreshPosition()),this.element[0].selectedIndex},_refreshValue:function(){var a=this.options.style=="popup"?" ui-state-active":"",b=this.widgetBaseClass+"-item-"+Math.round(Math.random()*1e3);this.list.find("."+this.widgetBaseClass+"-item-selected").removeClass(this.widgetBaseClass+"-item-selected"+a).find("a").attr("aria-selected","false").attr("id",""),this._selectedOptionLi().addClass(this.widgetBaseClass+"-item-selected"+a).find("a").attr("aria-selected","true").attr("id",b);var c=this.newelement.data("optionClasses")?this.newelement.data("optionClasses"):"",d=this._selectedOptionLi().data("optionClasses")?this._selectedOptionLi().data("optionClasses"):"";this.newelement.removeClass(c).data("optionClasses",d).addClass(d).find("."+this.widgetBaseClass+"-status").html(this._selectedOptionLi().find("a:eq(0)").html()),this.list.attr("aria-activedescendant",b)},_refreshPosition:function(){var b=this,c=this.options,d=b._pageScroll(),e=this.newelement.offset().top,f=a(window).height(),g=a(this.list[0]).outerHeight();if(e+g>f+d)e-=g;else if(this.newelement.is("."+this.widgetBaseClass+"-popup")){var h=this.list[0].scrollTop;this.list.find("li:lt("+this._selectedIndex()+")").each(function(){h-=a(this).outerHeight()}),e+=h}else e+=this.newelement.height();this.list.css({top:e,left:this.newelement.offset().left})},_pageScroll:function(){var a;return self.pageYOffset?a=self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?a=document.documentElement.scrollTop:document.body&&(a=document.body.scrollTop),a}})})